From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: DenaryDev <denaryplanet@gmail.com>
Date: Fri, 31 Dec 2021 03:37:11 +0500
Subject: [PATCH] Add PacketMessageEvent


diff --git a/src/main/java/net/minecraft/network/protocol/game/ClientboundChatPacket.java b/src/main/java/net/minecraft/network/protocol/game/ClientboundChatPacket.java
index 72734f37e5642f8c391aae7b18d6414dcfb0fd2a..61dc42113a1a6ed1eb8bf532d541bb5959ec856d 100644
--- a/src/main/java/net/minecraft/network/protocol/game/ClientboundChatPacket.java
+++ b/src/main/java/net/minecraft/network/protocol/game/ClientboundChatPacket.java
@@ -15,6 +15,7 @@ public class ClientboundChatPacket implements Packet<ClientGamePacketListener> {
     public net.md_5.bungee.api.chat.BaseComponent[] components; // Spigot
     private final ChatType type;
     private final UUID sender;
+    public UUID target; // Sapphire
 
     public ClientboundChatPacket(Component message, ChatType type, UUID sender) {
         this.message = message;
@@ -22,6 +23,15 @@ public class ClientboundChatPacket implements Packet<ClientGamePacketListener> {
         this.sender = sender != null ? sender : net.minecraft.Util.NIL_UUID;
     }
 
+    // Sapphire start - this need for PacketMessageEvent
+    public ClientboundChatPacket(Component message, ChatType type, UUID sender, UUID target) {
+        this.message = message;
+        this.type = type;
+        this.sender = sender != null ? sender : net.minecraft.Util.NIL_UUID;
+        this.target = target != null ? target : net.minecraft.Util.NIL_UUID;
+    }
+    // Sapphire end
+
     public ClientboundChatPacket(FriendlyByteBuf buf) {
         this.message = buf.readComponent();
         this.type = ChatType.getForIndex(buf.readByte());
diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index 2f5e40437d1865a874c352999edd084226d4e47b..d5f569275aab524638dcc10f2e0f9bea6db89710 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -1863,13 +1863,13 @@ public class ServerPlayer extends Player {
 
     public void sendMessage(Component message, ChatType type, UUID sender) {
         if (this.acceptsChat(type)) {
-            this.connection.send(new ClientboundChatPacket(message, type, sender), (future) -> {
+            this.connection.send(new ClientboundChatPacket(message, type, sender, getBukkitEntity().getUniqueId()), (future) -> { // Sapphire
                 if (!future.isSuccess() && (type == ChatType.GAME_INFO || type == ChatType.SYSTEM) && this.acceptsChat(ChatType.SYSTEM)) {
                     boolean flag = true;
                     String s = message.getString(256);
                     MutableComponent ichatmutablecomponent = (new TextComponent(s)).withStyle(ChatFormatting.YELLOW);
 
-                    this.connection.send(new ClientboundChatPacket((new TranslatableComponent("multiplayer.message_not_delivered", new Object[]{ichatmutablecomponent})).withStyle(ChatFormatting.RED), ChatType.SYSTEM, sender));
+                    this.connection.send(new ClientboundChatPacket((new TranslatableComponent("multiplayer.message_not_delivered", new Object[]{ichatmutablecomponent})).withStyle(ChatFormatting.RED), ChatType.SYSTEM, sender, getBukkitEntity().getUniqueId())); // Sapphire
                 }
 
             });
diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index 1a87f61d534ed531132fb43a9d2a45a4b604a6fc..58977831216a7c88b1016a4f7bc50dcbd8068ee3 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -2035,6 +2035,39 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Ser
         }
         // CraftBukkit end
 
+        // Sapphire start - call PacketMessageEvent
+        if (packet instanceof net.minecraft.network.protocol.game.ClientboundChatPacket chatPacket) {
+            net.kyori.adventure.text.Component message;
+            if (chatPacket.adventure$message != null) {
+                message = chatPacket.adventure$message;
+            } else {
+                if (chatPacket.components != null) {
+                    message = net.kyori.adventure.text.serializer.bungeecord.BungeeComponentSerializer.get().deserialize(chatPacket.components);
+                } else {
+                    message = net.kyori.adventure.text.serializer.gson.GsonComponentSerializer.gson().deserialize(Component.Serializer.toJson(chatPacket.getMessage()));
+                }
+            }
+
+            if (message != null && !message.equals(net.kyori.adventure.text.Component.empty())) {
+                io.sapphiremc.sapphire.api.event.PacketMessageEvent event;
+                java.util.UUID sender = chatPacket.getSender();
+                java.util.UUID target = chatPacket.target;
+                if (sender.equals(Util.NIL_UUID)) {
+                    event = new io.sapphiremc.sapphire.api.event.PacketMessageEvent(
+                        !org.bukkit.Bukkit.isPrimaryThread(), target, message, io.sapphiremc.sapphire.api.event.PacketMessageEvent.MessageType.valueOf(chatPacket.getType().name())
+                    );
+                } else {
+                    event = new io.sapphiremc.sapphire.api.event.PacketMessageEvent(
+                        !org.bukkit.Bukkit.isPrimaryThread(), sender, target, message, io.sapphiremc.sapphire.api.event.PacketMessageEvent.MessageType.valueOf(chatPacket.getType().name())
+                    );
+                }
+                org.bukkit.Bukkit.getPluginManager().callEvent(event);
+
+                chatPacket.adventure$message = event.getMessageComponent();
+            }
+        }
+        // Sapphire end
+
         try {
             this.connection.send(packet, listener);
         } catch (Throwable throwable) {
@@ -2104,7 +2137,7 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Ser
 
     private void handleChat(TextFilter.FilteredText message) {
         if (this.player.isRemoved() || this.player.getChatVisibility() == ChatVisiblity.HIDDEN) { // CraftBukkit - dead men tell no tales
-            this.send(new ClientboundChatPacket((new TranslatableComponent("chat.disabled.options")).withStyle(ChatFormatting.RED), ChatType.SYSTEM, Util.NIL_UUID));
+            this.send(new ClientboundChatPacket((new TranslatableComponent("chat.disabled.options")).withStyle(ChatFormatting.RED), ChatType.SYSTEM, Util.NIL_UUID, getCraftPlayer().getUniqueId())); // Sapphire
         } else {
             this.player.resetLastActionTime();
             String s = message.getRaw();
@@ -2129,7 +2162,7 @@ public class ServerGamePacketListenerImpl implements ServerPlayerConnection, Ser
                     }
                 });
             } else if (this.player.getChatVisibility() == ChatVisiblity.SYSTEM) { // Re-add "Command Only" flag check
-                this.send(new ClientboundChatPacket((new TranslatableComponent("chat.cannotSend")).withStyle(ChatFormatting.RED), ChatType.SYSTEM, Util.NIL_UUID));
+                this.send(new ClientboundChatPacket((new TranslatableComponent("chat.cannotSend")).withStyle(ChatFormatting.RED), ChatType.SYSTEM, Util.NIL_UUID, getCraftPlayer().getUniqueId())); // Sapphire
             } else if (true) {
                 this.chat(s, true);
                 // CraftBukkit end - the below is for reference. :)
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index f12efe51b14ed3637a8ba45def9c94634a6f5e8f..a0d931b0692b4f64e6d89661f5d3b3072b09c6a1 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -248,7 +248,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         if (this.getHandle().connection == null) return;
 
         for (Component component : CraftChatMessage.fromString(message)) {
-            this.getHandle().connection.send(new ClientboundChatPacket(component, ChatType.SYSTEM, Util.NIL_UUID));
+            this.getHandle().connection.send(new ClientboundChatPacket(component, ChatType.SYSTEM, Util.NIL_UUID, this.getUniqueId())); // Sapphire
         }
     }
 
@@ -257,7 +257,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         if (this.getHandle().connection == null) return;
 
         for (Component component : CraftChatMessage.fromString(message)) {
-            this.getHandle().connection.send(new ClientboundChatPacket(component, ChatType.CHAT, (sender == null) ? Util.NIL_UUID : sender));
+            this.getHandle().connection.send(new ClientboundChatPacket(component, ChatType.CHAT, (sender == null) ? Util.NIL_UUID : sender, this.getUniqueId())); // Sapphire
         }
     }
 
@@ -2476,7 +2476,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     @Override
     public void sendMessage(final net.kyori.adventure.identity.Identity identity, final net.kyori.adventure.text.Component message, final net.kyori.adventure.audience.MessageType type) {
         if (getHandle().connection == null) return;
-        final ClientboundChatPacket packet = new ClientboundChatPacket(null, type == net.kyori.adventure.audience.MessageType.CHAT ? net.minecraft.network.chat.ChatType.CHAT : net.minecraft.network.chat.ChatType.SYSTEM, identity.uuid());
+        final ClientboundChatPacket packet = new ClientboundChatPacket(null, type == net.kyori.adventure.audience.MessageType.CHAT ? net.minecraft.network.chat.ChatType.CHAT : net.minecraft.network.chat.ChatType.SYSTEM, identity.uuid(), this.getUniqueId()); // Sapphire
         packet.adventure$message = message;
         this.getHandle().connection.send(packet);
     }
@@ -2727,7 +2727,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         public void sendMessage(BaseComponent... components) {
            if ( CraftPlayer.this.getHandle().connection == null ) return;
 
-            ClientboundChatPacket packet = new ClientboundChatPacket(null, net.minecraft.network.chat.ChatType.SYSTEM, Util.NIL_UUID);
+            ClientboundChatPacket packet = new ClientboundChatPacket(null, net.minecraft.network.chat.ChatType.SYSTEM, Util.NIL_UUID, getUniqueId()); // Sapphire
             packet.components = components;
             CraftPlayer.this.getHandle().connection.send(packet);
         }
@@ -2751,7 +2751,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         public void sendMessage(net.md_5.bungee.api.ChatMessageType position, BaseComponent... components) {
             if ( CraftPlayer.this.getHandle().connection == null ) return;
 
-            ClientboundChatPacket packet = new ClientboundChatPacket(null, net.minecraft.network.chat.ChatType.getForIndex((byte) position.ordinal()), Util.NIL_UUID);
+            ClientboundChatPacket packet = new ClientboundChatPacket(null, net.minecraft.network.chat.ChatType.getForIndex((byte) position.ordinal()), Util.NIL_UUID, getUniqueId()); // Sapphire
             packet.components = components;
             CraftPlayer.this.getHandle().connection.send(packet);
         }
@@ -2765,7 +2765,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         public void sendMessage(net.md_5.bungee.api.ChatMessageType position, UUID sender, BaseComponent... components) {
             if ( CraftPlayer.this.getHandle().connection == null ) return;
 
-            ClientboundChatPacket packet = new ClientboundChatPacket(null, net.minecraft.network.chat.ChatType.getForIndex((byte) position.ordinal()), sender == null ? Util.NIL_UUID : sender);
+            ClientboundChatPacket packet = new ClientboundChatPacket(null, net.minecraft.network.chat.ChatType.getForIndex((byte) position.ordinal()), sender == null ? Util.NIL_UUID : sender, getUniqueId()); // Sapphire
             packet.components = components;
             CraftPlayer.this.getHandle().connection.send(packet);
         }
